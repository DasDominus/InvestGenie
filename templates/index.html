<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Efficient Frontier Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .portfolio-input {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .portfolio-input label {
            width: 180px;
            margin-right: 10px;
            font-size: 0.85rem;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        #efficient-frontier-plot {
            height: 500px;
        }
        #current-portfolio-info {
            margin-top: 20px;
        }
        .optimize-btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .asset-section {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .asset-section h5 {
            margin-bottom: 15px;
            font-weight: bold;
            color: #495057;
        }
        .asset-group-weight {
            font-weight: bold;
            margin-bottom: 15px;
            color: #495057;
        }
        #equity-weight, #fixed-income-weight {
            font-weight: bold;
        }
        .asset-type-header {
            background-color: #f8f9fa;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tab-content {
            padding-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center my-4">Portfolio Efficient Frontier Analysis</h1>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3>Efficient Frontier</h3>
                    </div>
                    <div class="card-body">
                        <div id="efficient-frontier-plot"></div>
                        <div class="loading" id="plot-loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Calculating efficient frontier...</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>Portfolio Metrics</h3>
                    </div>
                    <div class="card-body">
                        <div id="current-portfolio-info">
                            <p>No portfolio calculated yet.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3>Asset Allocation</h3>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4>Asset Class Weights</h4>
                                </div>
                                <div class="progress mb-2" style="height: 25px;">
                                    <div id="equity-progress" class="progress-bar bg-primary" role="progressbar" style="width: 60%;">
                                        <span id="equity-weight">60%</span>
                                    </div>
                                    <div id="fixed-income-progress" class="progress-bar bg-success" role="progressbar" style="width: 40%;">
                                        <span id="fixed-income-weight">40%</span>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between small text-muted">
                                    <span><span class="badge bg-primary">&nbsp;</span> Equity</span>
                                    <span><span class="badge bg-success">&nbsp;</span> Fixed Income</span>
                                </div>
                            </div>
                        </div>
                        
                        <ul class="nav nav-tabs" id="assetTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="equity-tab" data-bs-toggle="tab" data-bs-target="#equity" type="button" role="tab" aria-controls="equity" aria-selected="true">Equity Funds</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="fixed-tab" data-bs-toggle="tab" data-bs-target="#fixed" type="button" role="tab" aria-controls="fixed" aria-selected="false">Fixed Income</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="assetTabsContent">
                            <!-- Equity Tab -->
                            <div class="tab-pane fade show active" id="equity" role="tabpanel" aria-labelledby="equity-tab">
                                <div class="asset-type-header">
                                    <h5 class="mb-0">Equity Allocations</h5>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="reset-equity-btn">Reset</button>
                                </div>
                                <div id="equity-weights">
                                    <!-- Equity asset weights will be added here dynamically -->
                                </div>
                            </div>
                            
                            <!-- Fixed Income Tab -->
                            <div class="tab-pane fade" id="fixed" role="tabpanel" aria-labelledby="fixed-tab">
                                <div class="asset-type-header">
                                    <h5 class="mb-0">Fixed Income Allocations</h5>
                                    <button type="button" class="btn btn-sm btn-outline-success" id="reset-fixed-btn">Reset</button>
                                </div>
                                <div id="fixed-income-weights">
                                    <!-- Fixed income asset weights will be added here dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button type="button" class="btn btn-primary" id="calculate-btn">Calculate Portfolio</button>
                            <button type="button" class="btn btn-warning" id="reset-all-btn">Reset All</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>Portfolio Optimization</h3>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-12">
                                <h5>Predefined Portfolios</h5>
                                <button type="button" class="btn btn-success optimize-btn" id="max-sharpe-btn">Max Sharpe Ratio</button>
                                <button type="button" class="btn btn-info optimize-btn" id="min-vol-btn">Min Volatility</button>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <h5>Risk Profile Portfolios</h5>
                                <button type="button" class="btn btn-outline-danger optimize-btn" id="aggressive-btn">Aggressive (80/20)</button>
                                <button type="button" class="btn btn-outline-warning optimize-btn" id="balanced-btn">Balanced (60/40)</button>
                                <button type="button" class="btn btn-outline-primary optimize-btn" id="conservative-btn">Conservative (30/70)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Store data globally
        let efficientFrontierData = null;
        let currentPortfolio = null;
        let allAssets = [];
        let equityAssets = [];
        let fixedIncomeAssets = [];
        let assetDisplayNames = {};
        
        // Function to fetch efficient frontier data
        async function fetchEfficientFrontier() {
            document.getElementById('plot-loading').style.display = 'block';
            
            try {
                const response = await fetch('/api/efficient-frontier');
                efficientFrontierData = await response.json();
                
                // Store asset information
                allAssets = efficientFrontierData.assets;
                equityAssets = efficientFrontierData.equity_assets || [];
                fixedIncomeAssets = efficientFrontierData.fixed_income_assets || [];
                assetDisplayNames = efficientFrontierData.asset_names || {};
                
                // Initialize portfolio weights form
                initializePortfolioForm();
                
                // Plot efficient frontier
                plotEfficientFrontier();
            } catch (error) {
                console.error('Error fetching efficient frontier:', error);
                alert('Error fetching efficient frontier data. Please try again.');
            } finally {
                document.getElementById('plot-loading').style.display = 'none';
            }
        }
        
        // Function to initialize portfolio weights form
        function initializePortfolioForm() {
            const equityContainer = document.getElementById('equity-weights');
            const fixedIncomeContainer = document.getElementById('fixed-income-weights');
            
            equityContainer.innerHTML = '';
            fixedIncomeContainer.innerHTML = '';
            
            // Calculate default weights: equal weight within each asset class
            const equityWeight = 0.6; // 60% in equity
            const fixedIncomeWeight = 0.4; // 40% in fixed income
            
            const equalEquityWeight = equityAssets.length > 0 ? equityWeight / equityAssets.length : 0;
            const equalFixedIncomeWeight = fixedIncomeAssets.length > 0 ? fixedIncomeWeight / fixedIncomeAssets.length : 0;
            
            // Create equity inputs
            equityAssets.forEach(asset => {
                createAssetInput(asset, equalEquityWeight, 'equity');
            });
            
            // Create fixed income inputs
            fixedIncomeAssets.forEach(asset => {
                createAssetInput(asset, equalFixedIncomeWeight, 'fixed_income');
            });
            
            // Update asset class weight indicators
            updateAssetClassWeights();
        }
        
        // Function to create input for an asset
        function createAssetInput(asset, weight, assetType) {
            const container = assetType === 'equity' ? 
                document.getElementById('equity-weights') : 
                document.getElementById('fixed-income-weights');
            
            const displayName = assetDisplayNames[asset] || asset;
            
            const div = document.createElement('div');
            div.className = 'portfolio-input';
            
            const label = document.createElement('label');
            label.textContent = displayName;
            label.htmlFor = `weight-${asset}`;
            label.title = displayName;
            
            const input = document.createElement('input');
            input.type = 'range';
            input.className = 'form-range';
            input.id = `weight-${asset}`;
            input.dataset.assetType = assetType;
            input.min = '0';
            input.max = '1';
            input.step = '0.01';
            input.value = weight.toFixed(2);
            
            const valueDisplay = document.createElement('span');
            valueDisplay.className = 'ms-2';
            valueDisplay.textContent = `${(weight * 100).toFixed(0)}%`;
            
            input.addEventListener('input', () => {
                valueDisplay.textContent = `${(input.value * 100).toFixed(0)}%`;
                normalizeWeightsWithinGroup(input.id, assetType);
                updateAssetClassWeights();
            });
            
            div.appendChild(label);
            div.appendChild(input);
            div.appendChild(valueDisplay);
            
            container.appendChild(div);
        }
        
        // Function to normalize weights within an asset group
        function normalizeWeightsWithinGroup(changedInputId, assetType) {
            // Get all inputs for this asset type
            const assetSelector = `#${assetType === 'equity' ? 'equity-weights' : 'fixed-income-weights'} input[type="range"]`;
            const inputs = Array.from(document.querySelectorAll(assetSelector));
            
            // If we have no inputs, exit
            if (inputs.length === 0) return;
            
            // Calculate total weight excluding the changed input
            const changedInput = document.getElementById(changedInputId);
            const changedValue = parseFloat(changedInput.value);
            
            const otherInputs = inputs.filter(input => input.id !== changedInputId);
            const otherSum = otherInputs.reduce((sum, input) => sum + parseFloat(input.value), 0);
            
            // Get the current total allocated to this asset type
            const assetTypeTotal = getCurrentAssetTypeWeight(assetType);
            
            // If the new total exceeds 1, adjust other assets
            if (changedValue + otherSum > 1) {
                // If other sum is zero, we can't normalize proportionally
                if (otherSum === 0) {
                    changedInput.value = 1;
                    
                    // Update value display
                    const valueDisplay = changedInput.nextElementSibling;
                    valueDisplay.textContent = `${(changedInput.value * 100).toFixed(0)}%`;
                    return;
                }
                
                // Calculate scale factor to maintain the total
                const scaleFactor = (1 - changedValue) / otherSum;
                
                // Adjust other weights
                otherInputs.forEach(input => {
                    const newValue = parseFloat(input.value) * scaleFactor;
                    input.value = newValue.toFixed(2);
                    
                    // Update value display
                    const valueDisplay = input.nextElementSibling;
                    valueDisplay.textContent = `${(newValue * 100).toFixed(0)}%`;
                });
            }
        }
        
        // Get current weight allocated to an asset type
        function getCurrentAssetTypeWeight(assetType) {
            const assets = assetType === 'equity' ? equityAssets : fixedIncomeAssets;
            let total = 0;
            
            assets.forEach(asset => {
                const input = document.getElementById(`weight-${asset}`);
                if (input) {
                    total += parseFloat(input.value);
                }
            });
            
            return total;
        }
        
        // Update the asset class weight indicators
        function updateAssetClassWeights() {
            const equityTotal = getCurrentAssetTypeWeight('equity');
            const fixedIncomeTotal = getCurrentAssetTypeWeight('fixed_income');
            const total = equityTotal + fixedIncomeTotal;
            
            // Calculate percentages
            const equityPercent = total > 0 ? (equityTotal / total) * 100 : 0;
            const fixedIncomePercent = total > 0 ? (fixedIncomeTotal / total) * 100 : 0;
            
            // Update progress bars
            document.getElementById('equity-progress').style.width = `${equityPercent}%`;
            document.getElementById('fixed-income-progress').style.width = `${fixedIncomePercent}%`;
            
            // Update text
            document.getElementById('equity-weight').textContent = `${equityPercent.toFixed(0)}%`;
            document.getElementById('fixed-income-weight').textContent = `${fixedIncomePercent.toFixed(0)}%`;
        }
        
        // Function to get current portfolio weights for all assets
        function getCurrentWeights() {
            const weights = {};
            
            [...equityAssets, ...fixedIncomeAssets].forEach(asset => {
                const input = document.getElementById(`weight-${asset}`);
                if (input) {
                    weights[asset] = parseFloat(input.value);
                }
            });
            
            return weights;
        }
        
        // Function to calculate current portfolio
        async function calculatePortfolio() {
            const weights = getCurrentWeights();
            
            try {
                const response = await fetch('/api/portfolio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ weights })
                });
                
                currentPortfolio = await response.json();
                
                // Update portfolio info
                updatePortfolioInfo();
                
                // Update plot with current portfolio
                plotEfficientFrontier();
            } catch (error) {
                console.error('Error calculating portfolio:', error);
                alert('Error calculating portfolio metrics. Please try again.');
            }
        }
        
        // Function to update portfolio info
        function updatePortfolioInfo() {
            if (!currentPortfolio) return;
            
            const infoContainer = document.getElementById('current-portfolio-info');
            
            const expected_return = (currentPortfolio.expected_return * 100).toFixed(2);
            const volatility = (currentPortfolio.volatility * 100).toFixed(2);
            const sharpe_ratio = currentPortfolio.sharpe_ratio.toFixed(2);
            
            // Get asset type weights
            const equityWeight = currentPortfolio.asset_type_weights?.equity || 0;
            const fixedIncomeWeight = currentPortfolio.asset_type_weights?.fixed_income || 0;
            
            // Prepare asset weights HTML
            let equityWeightsList = '';
            let fixedIncomeWeightsList = '';
            
            for (const asset in currentPortfolio.weights) {
                const weight = currentPortfolio.weights[asset];
                const displayName = assetDisplayNames[asset] || asset;
                
                // If weights are objects with type
                if (typeof weight === 'object' && weight.type) {
                    const weightValue = weight.weight;
                    const weightPercent = (weightValue * 100).toFixed(2);
                    
                    if (weight.type === 'equity') {
                        equityWeightsList += `<li>${displayName}: ${weightPercent}%</li>`;
                    } else if (weight.type === 'fixed_income') {
                        fixedIncomeWeightsList += `<li>${displayName}: ${weightPercent}%</li>`;
                    }
                } 
                // If weights are simple numbers
                else {
                    const weightValue = typeof weight === 'number' ? weight : 0;
                    const weightPercent = (weightValue * 100).toFixed(2);
                    
                    // Determine type based on asset lists
                    if (equityAssets.includes(asset)) {
                        equityWeightsList += `<li>${displayName}: ${weightPercent}%</li>`;
                    } else if (fixedIncomeAssets.includes(asset)) {
                        fixedIncomeWeightsList += `<li>${displayName}: ${weightPercent}%</li>`;
                    }
                }
            }
            
            infoContainer.innerHTML = `
                <h4>Portfolio Metrics</h4>
                <ul>
                    <li>Expected Annual Return: ${expected_return}%</li>
                    <li>Annual Volatility: ${volatility}%</li>
                    <li>Sharpe Ratio: ${sharpe_ratio}</li>
                </ul>
                
                <h4>Asset Class Allocation</h4>
                <ul>
                    <li>Equity: ${(equityWeight * 100).toFixed(2)}%</li>
                    <li>Fixed Income: ${(fixedIncomeWeight * 100).toFixed(2)}%</li>
                </ul>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5>Equity Allocation</h5>
                        <ul>${equityWeightsList || '<li>None</li>'}</ul>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>Fixed Income Allocation</h5>
                        <ul>${fixedIncomeWeightsList || '<li>None</li>'}</ul>
                    </div>
                </div>
            `;
        }
        
        // Function to optimize portfolio
        async function optimizePortfolio(type, constraints = {}) {
            try {
                // Build query string
                let queryParams = `type=${type}`;
                for (const [key, value] of Object.entries(constraints)) {
                    queryParams += `&${key}=${value}`;
                }
                
                const response = await fetch(`/api/optimize?${queryParams}`);
                const data = await response.json();
                
                // Update portfolio weights in form
                updateFormFromWeights(data.metrics.weights);
                
                // Calculate portfolio with new weights
                await calculatePortfolio();
            } catch (error) {
                console.error(`Error optimizing portfolio for ${type}:`, error);
                alert(`Error optimizing portfolio. Please try again.`);
            }
        }
        
        // Function to update form values from weights
        function updateFormFromWeights(weights) {
            for (const asset in weights) {
                const input = document.getElementById(`weight-${asset}`);
                if (input) {
                    // Handle weights as objects with type
                    const weightValue = typeof weights[asset] === 'object' ? 
                        weights[asset].weight : weights[asset];
                    
                    input.value = weightValue.toFixed(2);
                    
                    // Update value display
                    const valueDisplay = input.nextElementSibling;
                    valueDisplay.textContent = `${(weightValue * 100).toFixed(0)}%`;
                }
            }
            
            // Update asset class weights
            updateAssetClassWeights();
        }
        
        // Function to reset weights for a specific asset type
        function resetAssetTypeWeights(assetType, targetRatio = null) {
            const assets = assetType === 'equity' ? equityAssets : fixedIncomeAssets;
            
            // If no ratio specified, use current balance
            if (targetRatio === null) {
                const currentEquityTotal = getCurrentAssetTypeWeight('equity');
                const currentFixedTotal = getCurrentAssetTypeWeight('fixed_income');
                const currentTotal = currentEquityTotal + currentFixedTotal;
                
                if (currentTotal > 0) {
                    targetRatio = assetType === 'equity' ? 
                        currentEquityTotal / currentTotal : 
                        currentFixedTotal / currentTotal;
                } else {
                    // Default ratios if no existing allocation
                    targetRatio = assetType === 'equity' ? 0.6 : 0.4;
                }
            }
            
            // Calculate equal weight for each asset in this type
            const equalWeight = assets.length > 0 ? targetRatio / assets.length : 0;
            
            // Set each asset to the equal weight
            assets.forEach(asset => {
                const input = document.getElementById(`weight-${asset}`);
                if (input) {
                    input.value = equalWeight.toFixed(2);
                    
                    // Update value display
                    const valueDisplay = input.nextElementSibling;
                    valueDisplay.textContent = `${(equalWeight * 100).toFixed(0)}%`;
                }
            });
            
            // Update asset class weights
            updateAssetClassWeights();
        }
        
        // Function to reset all weights
        function resetAllWeights() {
            resetAssetTypeWeights('equity', 0.6);  // 60% equity
            resetAssetTypeWeights('fixed_income', 0.4);  // 40% fixed income
            calculatePortfolio();
        }
        
        // Apply predefined asset allocation
        function applyPredefinedAllocation(equityRatio, fixedIncomeRatio) {
            resetAssetTypeWeights('equity', equityRatio);
            resetAssetTypeWeights('fixed_income', fixedIncomeRatio);
            calculatePortfolio();
        }
        
        // Function to plot efficient frontier
        function plotEfficientFrontier() {
            if (!efficientFrontierData) return;
            
            const ef = efficientFrontierData.efficient_frontier;
            const random = efficientFrontierData.random_portfolios;
            const min_vol = efficientFrontierData.min_volatility;
            const max_sharpe = efficientFrontierData.max_sharpe;
            
            const traces = [
                // Efficient Frontier line
                {
                    name: 'Efficient Frontier',
                    x: ef.volatilities,
                    y: ef.returns,
                    mode: 'lines',
                    line: {
                        color: 'rgba(0, 128, 0, 0.7)',
                        width: 3
                    }
                },
                // Random portfolios scatter
                {
                    name: 'Random Portfolios',
                    x: random.volatilities,
                    y: random.returns,
                    mode: 'markers',
                    marker: {
                        color: random.sharpe_ratios,
                        colorscale: 'Viridis',
                        size: 8,
                        opacity: 0.5,
                        colorbar: {
                            title: 'Sharpe Ratio'
                        }
                    },
                    type: 'scatter'
                },
                // Min Volatility point
                {
                    name: 'Minimum Volatility',
                    x: [min_vol.volatility],
                    y: [min_vol.return],
                    mode: 'markers',
                    marker: {
                        color: 'red',
                        size: 12,
                        symbol: 'circle'
                    }
                },
                // Max Sharpe point
                {
                    name: 'Maximum Sharpe Ratio',
                    x: [max_sharpe.volatility],
                    y: [max_sharpe.return],
                    mode: 'markers',
                    marker: {
                        color: 'gold',
                        size: 12,
                        symbol: 'star'
                    }
                }
            ];
            
            // Add current portfolio if available
            if (currentPortfolio) {
                traces.push({
                    name: 'Current Portfolio',
                    x: [currentPortfolio.volatility],
                    y: [currentPortfolio.expected_return],
                    mode: 'markers',
                    marker: {
                        color: 'blue',
                        size: 12,
                        symbol: 'diamond'
                    }
                });
            }
            
            const layout = {
                title: 'Efficient Frontier',
                xaxis: {
                    title: 'Annual Volatility (Standard Deviation)',
                    tickformat: '.1%'
                },
                yaxis: {
                    title: 'Annual Expected Return',
                    tickformat: '.1%'
                },
                hovermode: 'closest',
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1
                }
            };
            
            Plotly.newPlot('efficient-frontier-plot', traces, layout);
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch efficient frontier data on page load
            fetchEfficientFrontier();
            
            // Calculate button
            document.getElementById('calculate-btn').addEventListener('click', calculatePortfolio);
            
            // Reset buttons
            document.getElementById('reset-all-btn').addEventListener('click', resetAllWeights);
            document.getElementById('reset-equity-btn').addEventListener('click', () => resetAssetTypeWeights('equity'));
            document.getElementById('reset-fixed-btn').addEventListener('click', () => resetAssetTypeWeights('fixed_income'));
            
            // Optimize buttons
            document.getElementById('max-sharpe-btn').addEventListener('click', () => optimizePortfolio('max_sharpe'));
            document.getElementById('min-vol-btn').addEventListener('click', () => optimizePortfolio('min_volatility'));
            
            // Predefined allocation buttons
            document.getElementById('aggressive-btn').addEventListener('click', () => applyPredefinedAllocation(0.8, 0.2));
            document.getElementById('balanced-btn').addEventListener('click', () => applyPredefinedAllocation(0.6, 0.4));
            document.getElementById('conservative-btn').addEventListener('click', () => applyPredefinedAllocation(0.3, 0.7));
        });
    </script>
</body>
</html> 