<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestGenie - Portfolio Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            padding-top: 70px; /* Added padding for fixed navbar */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        #efficient-frontier-plot {
            height: 500px;
        }
        .optimize-btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .input-grid input {
            width: 100%;
            padding: 0.25rem;
        }
        .input-grid td {
            padding: 0.25rem;
        }
        .action-button {
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .csv-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .csv-controls input[type="file"] {
            max-width: 220px;
        }
        .allocation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .totals {
            font-weight: bold;
            color: #0d6efd;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">InvestGenie</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/providers">Provider Allocations</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="text-center mb-4">Portfolio Efficient Frontier Analysis</h1>
        
        <div class="row">
            <div class="col-lg-7">
                <!-- Efficient Frontier Section -->
                <div class="card">
                    <div class="card-header">
                        <h3>Efficient Frontier</h3>
                    </div>
                    <div class="card-body">
                        <div id="efficient-frontier-plot"></div>
                        <div class="loading" id="plot-loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Calculating efficient frontier...</p>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-success optimize-btn" id="max-sharpe-btn">Max Sharpe Ratio</button>
                            <button type="button" class="btn btn-info optimize-btn" id="min-vol-btn">Min Volatility</button>
                            <button type="button" class="btn btn-warning" id="reset-allocation-btn">Reset Allocation</button>
                        </div>
                    </div>
                </div>
                
                <!-- Portfolio Metrics Section -->
                <div class="card">
                    <div class="card-header">
                        <h3>Portfolio Metrics</h3>
                    </div>
                    <div class="card-body">
                        <div id="current-portfolio-info">
                            <p>No portfolio calculated yet.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-5">
                <!-- Asset Allocation Grid -->
                <div class="card">
                    <div class="card-header">
                        <div class="allocation-header">
                            <h3>Asset Allocation</h3>
                            <div class="csv-controls">
                                <div class="period-selector d-flex align-items-center me-2">
                                    <select class="form-select form-select-sm me-1" id="period-select">
                                        <option value="">Latest</option>
                                        <!-- Will be populated with available periods -->
                                    </select>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="load-period-btn">Load</button>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="save-csv-btn">Save CSV</button>
                                <div class="input-group">
                                    <input type="file" class="form-control form-control-sm" id="load-csv-input" accept=".csv">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="load-csv-btn">Load</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="current-period-info" class="alert alert-info mb-3" style="display: none;">
                            Showing allocations for: <span id="current-period-text"></span>
                        </div>
                        
                        <div class="mb-3">
                            <h4>Equity Allocation ($) <small class="text-muted">(Aggregated from providers - <a href="/providers">Provider Allocations</a>)</small></h4>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm input-grid" id="equity-allocation-grid">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Growth</th>
                                            <th>Blend</th>
                                            <th>Value</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <th>Small Cap</th>
                                            <td><input type="number" min="0" class="form-control equity-cell" data-row="small" data-col="growth" readonly></td>
                                            <td><input type="number" min="0" class="form-control equity-cell" data-row="small" data-col="blend" readonly></td>
                                            <td><input type="number" min="0" class="form-control equity-cell" data-row="small" data-col="value" readonly></td>
                                            <td class="text-end fw-bold" id="equity-small-total">$0</td>
                                        </tr>
                                        <tr>
                                            <th>Mid Cap</th>
                                            <td><input type="number" min="0" class="form-control equity-cell" data-row="mid" data-col="growth" readonly></td>
                                            <td><input type="number" min="0" class="form-control equity-cell" data-row="mid" data-col="blend" readonly></td>
                                            <td><input type="number" min="0" class="form-control equity-cell" data-row="mid" data-col="value" readonly></td>
                                            <td class="text-end fw-bold" id="equity-mid-total">$0</td>
                                        </tr>
                                        <tr>
                                            <th>Large Cap</th>
                                            <td><input type="number" min="0" class="form-control equity-cell" data-row="large" data-col="growth" readonly></td>
                                            <td><input type="number" min="0" class="form-control equity-cell" data-row="large" data-col="blend" readonly></td>
                                            <td><input type="number" min="0" class="form-control equity-cell" data-row="large" data-col="value" readonly></td>
                                            <td class="text-end fw-bold" id="equity-large-total">$0</td>
                                        </tr>
                                        <tr>
                                            <th>Total</th>
                                            <td class="text-end fw-bold" id="equity-growth-total">$0</td>
                                            <td class="text-end fw-bold" id="equity-blend-total">$0</td>
                                            <td class="text-end fw-bold" id="equity-value-total">$0</td>
                                            <td class="text-end fw-bold" id="equity-grand-total">$0</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h4>Fixed Income Allocation ($) <small class="text-muted">(Aggregated from providers - <a href="/providers">Provider Allocations</a>)</small></h4>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm input-grid" id="fixed-income-allocation-grid">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Low Risk</th>
                                            <th>Mid Risk</th>
                                            <th>High Risk</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <th>Short Term</th>
                                            <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="short" data-col="low" readonly></td>
                                            <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="short" data-col="mid" readonly></td>
                                            <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="short" data-col="high" readonly></td>
                                            <td class="text-end fw-bold" id="fixed-short-total">$0</td>
                                        </tr>
                                        <tr>
                                            <th>Mid Term</th>
                                            <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="mid" data-col="low" readonly></td>
                                            <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="mid" data-col="mid" readonly></td>
                                            <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="mid" data-col="high" readonly></td>
                                            <td class="text-end fw-bold" id="fixed-mid-total">$0</td>
                                        </tr>
                                        <tr>
                                            <th>Long Term</th>
                                            <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="long" data-col="low" readonly></td>
                                            <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="long" data-col="mid" readonly></td>
                                            <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="long" data-col="high" readonly></td>
                                            <td class="text-end fw-bold" id="fixed-long-total">$0</td>
                                        </tr>
                                        <tr>
                                            <th>Total</th>
                                            <td class="text-end fw-bold" id="fixed-low-total">$0</td>
                                            <td class="text-end fw-bold" id="fixed-mid-total">$0</td>
                                            <td class="text-end fw-bold" id="fixed-high-total">$0</td>
                                            <td class="text-end fw-bold" id="fixed-grand-total">$0</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h4>Cash Allocation ($) <small class="text-muted">(Aggregated from providers - <a href="/providers">Provider Allocations</a>)</small></h4>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm input-grid" id="cash-allocation-grid">
                                    <thead>
                                        <tr>
                                            <th>Cash Type</th>
                                            <th>Amount ($)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <th>Cash</th>
                                            <td><input type="number" min="0" class="form-control cash-cell" data-type="cash" readonly></td>
                                        </tr>
                                        <tr>
                                            <th>Money Market</th>
                                            <td><input type="number" min="0" class="form-control cash-cell" data-type="money_market" readonly></td>
                                        </tr>
                                        <tr>
                                            <th>Other Liquid Assets</th>
                                            <td><input type="number" min="0" class="form-control cash-cell" data-type="other_liquid" readonly></td>
                                        </tr>
                                        <tr>
                                            <th>Total</th>
                                            <td class="text-end fw-bold" id="cash-grand-total">$0</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="mb-3 totals">
                            <div class="row">
                                <div class="col-md-3">Equity: <span id="total-equity">$0</span></div>
                                <div class="col-md-3">Fixed Income: <span id="total-fixed-income">$0</span></div>
                                <div class="col-md-3">Cash: <span id="total-cash">$0</span></div>
                                <div class="col-md-3">Grand Total: <span id="allocation-grand-total">$0</span></div>
                            </div>
                        </div>
                        
                        <div class="mb-3 text-center">
                            <button type="button" class="btn btn-primary action-button" id="update-allocation-btn">Update Portfolio</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Store data globally
        let efficientFrontierData = null;
        let currentPortfolio = null;
        let assets = [];
        
        // Function to fetch efficient frontier data
        async function fetchEfficientFrontier() {
            document.getElementById('plot-loading').style.display = 'block';
            
            try {
                const response = await fetch('/api/efficient-frontier');
                efficientFrontierData = await response.json();
                assets = efficientFrontierData.assets;
                
                // Plot efficient frontier
                plotEfficientFrontier();
            } catch (error) {
                console.error('Error fetching efficient frontier:', error);
                alert('Error fetching efficient frontier data. Please try again.');
            } finally {
                document.getElementById('plot-loading').style.display = 'none';
            }
        }
        
        // Function to update portfolio info
        function updatePortfolioInfo() {
            if (!currentPortfolio) return;
            
            const infoContainer = document.getElementById('current-portfolio-info');
            
            const expected_return = (currentPortfolio.expected_return * 100).toFixed(2);
            const volatility = (currentPortfolio.volatility * 100).toFixed(2);
            const sharpe_ratio = currentPortfolio.sharpe_ratio.toFixed(2);
            
            let weightsList = '';
            for (const [asset, weight] of Object.entries(currentPortfolio.weights)) {
                if (weight > 0.001) { // Only show assets with significant weights
                    weightsList += `<li>${asset}: ${(weight * 100).toFixed(2)}%</li>`;
                }
            }
            
            infoContainer.innerHTML = `
                <h4>Portfolio Metrics</h4>
                <ul>
                    <li>Expected Annual Return: ${expected_return}%</li>
                    <li>Annual Volatility: ${volatility}%</li>
                    <li>Sharpe Ratio: ${sharpe_ratio}</li>
                </ul>
                
                <h4>Asset Weights</h4>
                <ul>${weightsList}</ul>
            `;
        }
        
        // Function to optimize portfolio
        async function optimizePortfolio(type) {
            try {
                const response = await fetch(`/api/optimize?type=${type}`);
                const data = await response.json();
                
                // Calculate portfolio with optimized weights
                currentPortfolio = data.metrics;
                updatePortfolioInfo();
                plotEfficientFrontier();
                
                // Update the allocation grids based on the optimized portfolio
                // This maps the optimized weights back to the allocation grids
                updateAllocationGridsFromWeights(currentPortfolio.weights);
            } catch (error) {
                console.error(`Error optimizing portfolio for ${type}:`, error);
                alert(`Error optimizing portfolio. Please try again.`);
            }
        }
        
        // Function to update allocation grids from weights
        function updateAllocationGridsFromWeights(weights) {
            // First reset all grids
            resetAllocation();
            
            // Get total portfolio value - for simplicity, assume $100,000 total
            const totalPortfolioValue = 100000;
            
            // Update equity grid
            Object.keys(weights).forEach(asset => {
                if (asset.startsWith('equity_') && weights[asset] > 0) {
                    const [_, size, style] = asset.split('_');
                    const cell = document.querySelector(`.equity-cell[data-row="${size}"][data-col="${style}"]`);
                    if (cell) {
                        cell.value = Math.round(weights[asset] * totalPortfolioValue);
                    }
                }
            });
            
            // Update fixed income grid
            Object.keys(weights).forEach(asset => {
                if (asset.startsWith('fixed_') && weights[asset] > 0) {
                    const [_, term, risk] = asset.split('_');
                    const cell = document.querySelector(`.fixed-income-cell[data-row="${term}"][data-col="${risk}"]`);
                    if (cell) {
                        cell.value = Math.round(weights[asset] * totalPortfolioValue);
                    }
                }
            });
            
            // Recalculate totals
            calculateEquityTotals();
            calculateFixedIncomeTotals();
            calculateGrandTotal();
        }
        
        // Function to plot efficient frontier
        function plotEfficientFrontier() {
            if (!efficientFrontierData) return;
            
            const ef = efficientFrontierData.efficient_frontier;
            const random = efficientFrontierData.random_portfolios;
            const min_vol = efficientFrontierData.min_volatility;
            const max_sharpe = efficientFrontierData.max_sharpe;
            
            const traces = [
                // Efficient Frontier line
                {
                    name: 'Efficient Frontier',
                    x: ef.volatilities,
                    y: ef.returns,
                    mode: 'lines',
                    line: {
                        color: 'rgba(0, 128, 0, 0.7)',
                        width: 3
                    }
                },
                // Random portfolios scatter
                {
                    name: 'Random Portfolios',
                    x: random.volatilities,
                    y: random.returns,
                    mode: 'markers',
                    marker: {
                        color: random.sharpe_ratios,
                        colorscale: 'Viridis',
                        size: 8,
                        opacity: 0.5,
                        colorbar: {
                            title: 'Sharpe Ratio'
                        }
                    },
                    type: 'scatter'
                },
                // Min Volatility point
                {
                    name: 'Minimum Volatility',
                    x: [min_vol.volatility],
                    y: [min_vol.return],
                    mode: 'markers',
                    marker: {
                        color: 'red',
                        size: 12,
                        symbol: 'circle'
                    }
                },
                // Max Sharpe point
                {
                    name: 'Maximum Sharpe Ratio',
                    x: [max_sharpe.volatility],
                    y: [max_sharpe.return],
                    mode: 'markers',
                    marker: {
                        color: 'gold',
                        size: 12,
                        symbol: 'star'
                    }
                }
            ];
            
            // Add current portfolio if available
            if (currentPortfolio) {
                traces.push({
                    name: 'Current Portfolio',
                    x: [currentPortfolio.volatility],
                    y: [currentPortfolio.expected_return],
                    mode: 'markers',
                    marker: {
                        color: 'blue',
                        size: 12,
                        symbol: 'diamond'
                    }
                });
            }
            
            const layout = {
                title: 'Efficient Frontier',
                xaxis: {
                    title: 'Annual Volatility (Standard Deviation)',
                    tickformat: '.1%'
                },
                yaxis: {
                    title: 'Annual Expected Return',
                    tickformat: '.1%'
                },
                hovermode: 'closest',
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1
                }
            };
            
            Plotly.newPlot('efficient-frontier-plot', traces, layout);
        }
        
        // Function to initialize allocation grids
        function initializeAllocationGrids() {
            // Add event listeners to equity grid cells
            document.querySelectorAll('.equity-cell').forEach(input => {
                input.value = 0; // Initialize with zero
                input.addEventListener('input', () => {
                    calculateEquityTotals();
                    calculateGrandTotal();
                });
            });
            
            // Add event listeners to fixed income grid cells
            document.querySelectorAll('.fixed-income-cell').forEach(input => {
                input.value = 0; // Initialize with zero
                input.addEventListener('input', () => {
                    calculateFixedIncomeTotals();
                    calculateGrandTotal();
                });
            });
            
            // Initialize totals
            calculateEquityTotals();
            calculateFixedIncomeTotals();
            calculateGrandTotal();
        }
        
        // Function to calculate equity grid totals
        function calculateEquityTotals() {
            // Row totals
            const rows = ['small', 'mid', 'large'];
            const cols = ['growth', 'blend', 'value'];
            
            // Calculate row totals
            rows.forEach(row => {
                let rowTotal = 0;
                cols.forEach(col => {
                    const cell = document.querySelector(`.equity-cell[data-row="${row}"][data-col="${col}"]`);
                    rowTotal += Number(cell.value) || 0;
                });
                document.getElementById(`equity-${row}-total`).textContent = formatCurrency(rowTotal);
            });
            
            // Calculate column totals
            cols.forEach(col => {
                let colTotal = 0;
                rows.forEach(row => {
                    const cell = document.querySelector(`.equity-cell[data-row="${row}"][data-col="${col}"]`);
                    colTotal += Number(cell.value) || 0;
                });
                document.getElementById(`equity-${col}-total`).textContent = formatCurrency(colTotal);
            });
            
            // Calculate grand total
            let grandTotal = 0;
            document.querySelectorAll('.equity-cell').forEach(cell => {
                grandTotal += Number(cell.value) || 0;
            });
            document.getElementById('equity-grand-total').textContent = formatCurrency(grandTotal);
            document.getElementById('total-equity').textContent = formatCurrency(grandTotal);
        }
        
        // Function to calculate fixed income grid totals
        function calculateFixedIncomeTotals() {
            // Row totals
            const rows = ['short', 'mid', 'long'];
            const cols = ['low', 'mid', 'high'];
            
            // Calculate row totals
            rows.forEach(row => {
                let rowTotal = 0;
                cols.forEach(col => {
                    const cell = document.querySelector(`.fixed-income-cell[data-row="${row}"][data-col="${col}"]`);
                    rowTotal += Number(cell.value) || 0;
                });
                document.getElementById(`fixed-${row}-total`).textContent = formatCurrency(rowTotal);
            });
            
            // Calculate column totals
            cols.forEach(col => {
                let colTotal = 0;
                rows.forEach(row => {
                    const cell = document.querySelector(`.fixed-income-cell[data-row="${row}"][data-col="${col}"]`);
                    colTotal += Number(cell.value) || 0;
                });
                document.getElementById(`fixed-${col}-total`).textContent = formatCurrency(colTotal);
            });
            
            // Calculate grand total
            let grandTotal = 0;
            document.querySelectorAll('.fixed-income-cell').forEach(cell => {
                grandTotal += Number(cell.value) || 0;
            });
            document.getElementById('fixed-grand-total').textContent = formatCurrency(grandTotal);
            document.getElementById('total-fixed-income').textContent = formatCurrency(grandTotal);
        }
        
        // Function to calculate grand total
        function calculateGrandTotal() {
            const equityTotal = document.querySelectorAll('.equity-cell').length > 0 ? 
                Array.from(document.querySelectorAll('.equity-cell')).reduce((sum, cell) => sum + (Number(cell.value) || 0), 0) : 0;
                
            const fixedIncomeTotal = document.querySelectorAll('.fixed-income-cell').length > 0 ? 
                Array.from(document.querySelectorAll('.fixed-income-cell')).reduce((sum, cell) => sum + (Number(cell.value) || 0), 0) : 0;
                
            const cashTotal = document.querySelectorAll('.cash-cell').length > 0 ? 
                Array.from(document.querySelectorAll('.cash-cell')).reduce((sum, cell) => sum + (Number(cell.value) || 0), 0) : 0;
                
            document.getElementById('total-cash').textContent = formatCurrency(cashTotal);
            document.getElementById('cash-grand-total').textContent = formatCurrency(cashTotal);
            
            const grandTotal = equityTotal + fixedIncomeTotal + cashTotal;
            document.getElementById('allocation-grand-total').textContent = formatCurrency(grandTotal);
        }
        
        // Function to format currency
        function formatCurrency(value) {
            return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        
        // Function to convert allocation grid to portfolio weights
        function getAllocationWeights() {
            // Get total allocation
            const totalAllocation = parseFloat(document.getElementById('allocation-grand-total').textContent.replace('$', '').replace(/,/g, '')) || 0;
            
            if (totalAllocation === 0) {
                alert('Please allocate some funds before updating the portfolio.');
                return null;
            }
            
            // Create weights object
            const weights = {};
            
            // Process equity allocation
            document.querySelectorAll('.equity-cell').forEach(cell => {
                const row = cell.dataset.row;
                const col = cell.dataset.col;
                const value = Number(cell.value) || 0;
                
                if (value > 0) {
                    const assetKey = `equity_${row}_${col}`;
                    weights[assetKey] = value / totalAllocation;
                }
            });
            
            // Process fixed income allocation
            document.querySelectorAll('.fixed-income-cell').forEach(cell => {
                const row = cell.dataset.row;
                const col = cell.dataset.col;
                const value = Number(cell.value) || 0;
                
                if (value > 0) {
                    const assetKey = `fixed_${row}_${col}`;
                    weights[assetKey] = value / totalAllocation;
                }
            });
            
            // Process cash allocation
            document.querySelectorAll('.cash-cell').forEach(cell => {
                const cashType = cell.dataset.type;
                const value = Number(cell.value) || 0;
                
                if (value > 0) {
                    const assetKey = `cash_${cashType}`;
                    weights[assetKey] = value / totalAllocation;
                }
            });
            
            return weights;
        }
        
        // Function to update portfolio based on allocation
        function updateAllocation() {
            const allocationWeights = getAllocationWeights();
            
            if (!allocationWeights) return;
            
            // Calculate portfolio with new weights
            fetch('/api/portfolio', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ weights: allocationWeights })
            })
            .then(response => response.json())
            .then(data => {
                currentPortfolio = data;
                updatePortfolioInfo();
                plotEfficientFrontier();
                // alert('Portfolio updated based on asset allocation.');
            })
            .catch(error => {
                console.error('Error updating portfolio from allocation:', error);
                alert('Error updating portfolio. Please try again.');
            });
        }
        
        // Function to reset allocation
        function resetAllocation() {
            // Reset all input fields to zero
            document.querySelectorAll('.equity-cell, .fixed-income-cell, .cash-cell').forEach(cell => {
                cell.value = 0;
            });
            
            // Recalculate totals
            calculateEquityTotals();
            calculateFixedIncomeTotals();
            calculateGrandTotal();
        }
        
        // Function to save allocation to CSV
        function saveAllocationToCSV() {
            // Get allocation data
            const allocation = [];
            
            // Add equity data
            document.querySelectorAll('.equity-cell').forEach(cell => {
                const row = cell.dataset.row;
                const col = cell.dataset.col;
                const value = Number(cell.value) || 0;
                
                if (value > 0) {
                    allocation.push({
                        type: 'equity',
                        size_term: row,
                        style_risk: col,
                        amount: value
                    });
                }
            });
            
            // Add fixed income data
            document.querySelectorAll('.fixed-income-cell').forEach(cell => {
                const row = cell.dataset.row;
                const col = cell.dataset.col;
                const value = Number(cell.value) || 0;
                
                if (value > 0) {
                    allocation.push({
                        type: 'fixed',
                        size_term: row,
                        style_risk: col,
                        amount: value
                    });
                }
            });
            
            // Add cash data
            document.querySelectorAll('.cash-cell').forEach(cell => {
                const cashType = cell.dataset.type;
                const value = Number(cell.value) || 0;
                
                if (value > 0) {
                    allocation.push({
                        type: 'cash',
                        cash_type: cashType,
                        amount: value
                    });
                }
            });
            
            // If no allocation, show error
            if (allocation.length === 0) {
                alert('Please allocate some funds before saving.');
                return;
            }
            
            // Save using server API
            fetch('/api/allocations/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ allocation })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Allocation saved successfully as ${data.filename}`);
                    // Optionally, update a list of saved allocations if we had one
                } else {
                    alert(`Error: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error saving allocation:', error);
                alert('Error saving allocation. Please try again.');
            });
            
            // Also offer local download as an alternative
            const csvContent = "type,size_term,style_risk,amount\n" + 
                allocation.map(item => `${item.type},${item.size_term},${item.style_risk},${item.amount}`).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'allocation.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Function to load allocation from CSV
        function loadAllocationFromCSV(file) {
            // If file is provided, load from file
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    processCSVContent(event.target.result);
                };
                
                reader.readAsText(file);
            } else {
                // If no file provided, show a list of server-saved allocations
                fetch('/api/allocations/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.files.length > 0) {
                        // For simplicity, just load the most recent one
                        // In a real app, you'd show a selection UI
                        const mostRecent = data.files[0];
                        loadAllocationFromServer(mostRecent.filename);
                    } else {
                        alert('No saved allocations found on server.');
                    }
                })
                .catch(error => {
                    console.error('Error listing allocations:', error);
                    alert('Error loading allocation list. Please try again.');
                });
            }
        }
        
        // Function to load allocation from server
        function loadAllocationFromServer(filename) {
            fetch(`/api/allocations/load/${filename}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.allocation) {
                    // Reset current allocation
                    resetAllocation();
                    
                    // Process allocation data
                    data.allocation.forEach(item => {
                        const type = item.type;
                        const sizeOrTerm = item.size_term;
                        const styleOrRisk = item.style_risk;
                        const amount = item.amount;
                        
                        if (type === 'equity') {
                            const cell = document.querySelector(`.equity-cell[data-row="${sizeOrTerm}"][data-col="${styleOrRisk}"]`);
                            if (cell) {
                                cell.value = amount;
                            }
                        } else if (type === 'fixed') {
                            const cell = document.querySelector(`.fixed-income-cell[data-row="${sizeOrTerm}"][data-col="${styleOrRisk}"]`);
                            if (cell) {
                                cell.value = amount;
                            }
                        } else if (type === 'cash') {
                            const cell = document.querySelector(`.cash-cell[data-type="${styleOrRisk}"]`);
                            if (cell) {
                                cell.value = amount;
                            }
                        }
                    });
                    
                    // Update totals
                    calculateEquityTotals();
                    calculateFixedIncomeTotals();
                    calculateGrandTotal();
                    
                    // Update portfolio
                    updateAllocation();
                    
                    alert(`Allocation loaded from ${filename}`);
                } else {
                    alert(`Error: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error loading allocation:', error);
                alert('Error loading allocation. Please try again.');
            });
        }
        
        // Function to process CSV content
        function processCSVContent(csvContent) {
            // Reset current allocation
            resetAllocation();
            
            // Parse CSV content
            const lines = csvContent.split('\n');
            
            // Skip header row
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const fields = line.split(',');
                const type = fields[0];
                
                if (type === 'equity') {
                    const [_, sizeOrTerm, styleOrRisk, amount] = fields;
                    const cell = document.querySelector(`.equity-cell[data-row="${sizeOrTerm}"][data-col="${styleOrRisk}"]`);
                    if (cell) {
                        cell.value = amount;
                    }
                } else if (type === 'fixed') {
                    const [_, sizeOrTerm, styleOrRisk, amount] = fields;
                    const cell = document.querySelector(`.fixed-income-cell[data-row="${sizeOrTerm}"][data-col="${styleOrRisk}"]`);
                    if (cell) {
                        cell.value = amount;
                    }
                } else if (type === 'cash') {
                    const [_, cashType, __, amount] = fields; // Notes field may be present
                    const cell = document.querySelector(`.cash-cell[data-type="${cashType}"]`);
                    if (cell) {
                        cell.value = amount;
                    }
                }
            }
            
            // Update totals
            calculateEquityTotals();
            calculateFixedIncomeTotals();
            calculateGrandTotal();
            
            // Update portfolio
            updateAllocation();
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch efficient frontier data on page load
            fetchEfficientFrontier();
            
            // Initialize allocation grids
            initializeAllocationGrids();
            
            // Optimize buttons
            document.getElementById('max-sharpe-btn').addEventListener('click', () => optimizePortfolio('max_sharpe'));
            document.getElementById('min-vol-btn').addEventListener('click', () => optimizePortfolio('min_volatility'));
            
            // Allocation update button
            document.getElementById('update-allocation-btn').addEventListener('click', updateAllocation);
            
            // Reset allocation button (we've changed the handler above but we need to call this function)
            // document.getElementById('reset-allocation-btn').addEventListener('click', resetAllocation);
            
            // CSV save/load buttons
            document.getElementById('save-csv-btn').addEventListener('click', saveAllocationToCSV);
            
            document.getElementById('load-csv-btn').addEventListener('click', () => {
                const fileInput = document.getElementById('load-csv-input');
                if (fileInput.files.length > 0) {
                    loadAllocationFromCSV(fileInput.files[0]);
                } else {
                    // Ask if the user wants to load from server
                    if (confirm('No file selected. Would you like to load a previously saved allocation from server?')) {
                        loadAllocationFromCSV(null); // null will trigger server loading
                    }
                }
            });
            
            // Load available periods
            loadAvailablePeriods();
            
            // Add event listener for loading specific periods
            document.getElementById('load-period-btn').addEventListener('click', () => {
                const periodValue = document.getElementById('period-select').value;
                if (periodValue) {
                    const [year, quarter] = periodValue.split('_');
                    loadAggregatedProviderAllocations(year, quarter);
                } else {
                    // Load latest
                    loadAggregatedProviderAllocations();
                }
            });
            
            // Check if we have a saved period in localStorage and load it
            const savedYear = localStorage.getItem('investGenie_selectedYear');
            const savedQuarter = localStorage.getItem('investGenie_selectedQuarter');
            
            if (savedYear && savedQuarter) {
                loadAggregatedProviderAllocations(savedYear, savedQuarter);
            } else {
                // Load latest
                loadAggregatedProviderAllocations();
            }
        });
        
        // Find and load periods
        function loadAvailablePeriods() {
            fetch('/api/providers/periods')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.periods.length > 0) {
                        const periodSelect = document.getElementById('period-select');
                        
                        // Clear existing options except the "Latest" option
                        while (periodSelect.options.length > 1) {
                            periodSelect.remove(1);
                        }
                        
                        // Add periods to the dropdown
                        data.periods.forEach(period => {
                            period.quarters.forEach(quarter => {
                                const option = document.createElement('option');
                                option.value = `${period.year}_${quarter}`;
                                option.textContent = `${period.year} Q${quarter}`;
                                periodSelect.appendChild(option);
                            });
                        });
                        
                        // Select the current period if saved in localStorage
                        const savedYear = localStorage.getItem('investGenie_selectedYear');
                        const savedQuarter = localStorage.getItem('investGenie_selectedQuarter');
                        
                        if (savedYear && savedQuarter) {
                            const optionValue = `${savedYear}_${savedQuarter}`;
                            const option = Array.from(periodSelect.options).find(opt => opt.value === optionValue);
                            
                            if (option) {
                                periodSelect.value = optionValue;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading periods:', error);
                });
        }
        
        // Function to load aggregated provider allocations
        function loadAggregatedProviderAllocations(year = null, quarter = null) {
            let url = '/api/providers/aggregate';
            if (year && quarter) {
                url += `?year=${year}&quarter=${quarter}`;
                
                // Save selected period to localStorage
                localStorage.setItem('investGenie_selectedYear', year);
                localStorage.setItem('investGenie_selectedQuarter', quarter);
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const allocation = data.allocation;
                        
                        // Reset input fields without calling loadAggregatedProviderAllocations again
                        document.querySelectorAll('.equity-cell, .fixed-income-cell, .cash-cell').forEach(cell => {
                            cell.value = 0;
                        });
                        
                        // Update equity cells
                        for (const [key, value] of Object.entries(allocation.equity)) {
                            const [row, col] = key.split('_');
                            const cell = document.querySelector(`.equity-cell[data-row="${row}"][data-col="${col}"]`);
                            if (cell) {
                                cell.value = value;
                            }
                        }
                        
                        // Update fixed income cells
                        for (const [key, value] of Object.entries(allocation.fixed_income)) {
                            const [row, col] = key.split('_');
                            const cell = document.querySelector(`.fixed-income-cell[data-row="${row}"][data-col="${col}"]`);
                            if (cell) {
                                cell.value = value;
                            }
                        }
                        
                        // Update cash cells
                        for (const [key, value] of Object.entries(allocation.cash)) {
                            const cell = document.querySelector(`.cash-cell[data-type="${key}"]`);
                            if (cell) {
                                cell.value = value;
                            }
                        }
                        
                        // Recalculate totals
                        calculateEquityTotals();
                        calculateFixedIncomeTotals();
                        calculateGrandTotal();
                        
                        // Update portfolio based on allocation
                        updateAllocation();
                        
                        // Update period indicator if period info is available
                        if (data.period) {
                            const periodIndicator = document.getElementById('current-period-info');
                            const periodText = document.getElementById('current-period-text');
                            periodText.textContent = `${data.period.year} Q${data.period.quarter}`;
                            periodIndicator.style.display = 'block';
                            
                            // If period was returned from API, save it to localStorage
                            localStorage.setItem('investGenie_selectedYear', data.period.year);
                            localStorage.setItem('investGenie_selectedQuarter', data.period.quarter);
                        } else {
                            document.getElementById('current-period-info').style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading aggregated allocations:', error);
                });
        }
    </script>
</body>
</html> 