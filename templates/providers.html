<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestGenie - Provider Allocations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 70px; /* Added padding for fixed navbar */
            padding-bottom: 20px;
        }
        .container {
            max-width: 1200px;
        }
        .allocation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .input-grid input {
            width: 100%;
            text-align: right;
        }
        .totals {
            font-weight: bold;
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .action-button {
            min-width: 120px;
        }
        .provider-card {
            margin-bottom: 20px;
        }
        .provider-controls {
            margin-bottom: 20px;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">InvestGenie</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/providers">Provider Allocations</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="mb-4">Provider Allocations</h1>

        <div class="provider-controls">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" id="new-provider-name" placeholder="Provider Name (e.g., Chase, Charles Schwab)">
                        <button class="btn btn-primary" id="add-provider-btn">Add Provider</button>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="period-selector d-flex justify-content-end align-items-center">
                        <div class="me-2">
                            <label for="year-select" class="form-label mb-0 me-1">Year:</label>
                            <select class="form-select form-select-sm d-inline-block w-auto" id="year-select">
                                <!-- Years will be populated dynamically -->
                            </select>
                        </div>
                        <div class="me-2">
                            <label for="quarter-select" class="form-label mb-0 me-1">Quarter:</label>
                            <select class="form-select form-select-sm d-inline-block w-auto" id="quarter-select">
                                <option value="1">Q1</option>
                                <option value="2">Q2</option>
                                <option value="3">Q3</option>
                                <option value="4">Q4</option>
                            </select>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm me-2" id="copy-last-period-btn">Copy Last Allocation</button>
                        <button class="btn btn-success" id="save-providers-btn">Save</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="current-period-indicator" class="alert alert-info mb-3" style="display: none;">
            Currently viewing: <span id="current-period-text"></span>
        </div>

        <div id="provider-list">
            <!-- Provider cards will be dynamically added here -->
        </div>

        <!-- Provider Template -->
        <template id="provider-template">
            <div class="card provider-card" data-provider-id="">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="provider-name mb-0"></h3>
                        <div>
                            <button class="btn btn-sm btn-danger remove-provider-btn">Remove</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h4>Equity Allocation ($)</h4>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm input-grid equity-allocation-grid">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Growth</th>
                                        <th>Blend</th>
                                        <th>Value</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <th>Small Cap</th>
                                        <td><input type="number" min="0" class="form-control equity-cell" data-row="small" data-col="growth"></td>
                                        <td><input type="number" min="0" class="form-control equity-cell" data-row="small" data-col="blend"></td>
                                        <td><input type="number" min="0" class="form-control equity-cell" data-row="small" data-col="value"></td>
                                        <td class="text-end fw-bold equity-small-total">$0</td>
                                    </tr>
                                    <tr>
                                        <th>Mid Cap</th>
                                        <td><input type="number" min="0" class="form-control equity-cell" data-row="mid" data-col="growth"></td>
                                        <td><input type="number" min="0" class="form-control equity-cell" data-row="mid" data-col="blend"></td>
                                        <td><input type="number" min="0" class="form-control equity-cell" data-row="mid" data-col="value"></td>
                                        <td class="text-end fw-bold equity-mid-total">$0</td>
                                    </tr>
                                    <tr>
                                        <th>Large Cap</th>
                                        <td><input type="number" min="0" class="form-control equity-cell" data-row="large" data-col="growth"></td>
                                        <td><input type="number" min="0" class="form-control equity-cell" data-row="large" data-col="blend"></td>
                                        <td><input type="number" min="0" class="form-control equity-cell" data-row="large" data-col="value"></td>
                                        <td class="text-end fw-bold equity-large-total">$0</td>
                                    </tr>
                                    <tr>
                                        <th>Total</th>
                                        <td class="text-end fw-bold equity-growth-total">$0</td>
                                        <td class="text-end fw-bold equity-blend-total">$0</td>
                                        <td class="text-end fw-bold equity-value-total">$0</td>
                                        <td class="text-end fw-bold equity-grand-total">$0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h4>Fixed Income Allocation ($)</h4>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm input-grid fixed-income-allocation-grid">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Low Risk</th>
                                        <th>Mid Risk</th>
                                        <th>High Risk</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <th>Short Term</th>
                                        <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="short" data-col="low"></td>
                                        <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="short" data-col="mid"></td>
                                        <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="short" data-col="high"></td>
                                        <td class="text-end fw-bold fixed-short-total">$0</td>
                                    </tr>
                                    <tr>
                                        <th>Mid Term</th>
                                        <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="mid" data-col="low"></td>
                                        <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="mid" data-col="mid"></td>
                                        <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="mid" data-col="high"></td>
                                        <td class="text-end fw-bold fixed-mid-total">$0</td>
                                    </tr>
                                    <tr>
                                        <th>Long Term</th>
                                        <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="long" data-col="low"></td>
                                        <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="long" data-col="mid"></td>
                                        <td><input type="number" min="0" class="form-control fixed-income-cell" data-row="long" data-col="high"></td>
                                        <td class="text-end fw-bold fixed-long-total">$0</td>
                                    </tr>
                                    <tr>
                                        <th>Total</th>
                                        <td class="text-end fw-bold fixed-low-total">$0</td>
                                        <td class="text-end fw-bold fixed-mid-total">$0</td>
                                        <td class="text-end fw-bold fixed-high-total">$0</td>
                                        <td class="text-end fw-bold fixed-grand-total">$0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-3 totals">
                        <div class="row">
                            <div class="col-md-4">Equity: <span class="total-equity">$0</span></div>
                            <div class="col-md-4">Fixed Income: <span class="total-fixed-income">$0</span></div>
                            <div class="col-md-4">Grand Total: <span class="provider-grand-total">$0</span></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h4>Cash Allocation ($)</h4>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm input-grid cash-allocation-grid">
                                <thead>
                                    <tr>
                                        <th>Cash Type</th>
                                        <th>Amount ($)</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <th>Cash</th>
                                        <td><input type="number" min="0" class="form-control cash-cell" data-type="cash"></td>
                                        <td><input type="text" class="form-control cash-notes" data-type="cash" placeholder="e.g., Checking account"></td>
                                    </tr>
                                    <tr>
                                        <th>Money Market</th>
                                        <td><input type="number" min="0" class="form-control cash-cell" data-type="money_market"></td>
                                        <td><input type="text" class="form-control cash-notes" data-type="money_market" placeholder="e.g., Goldman Sachs MM Fund"></td>
                                    </tr>
                                    <tr>
                                        <th>Other Liquid Assets</th>
                                        <td><input type="number" min="0" class="form-control cash-cell" data-type="other_liquid"></td>
                                        <td><input type="text" class="form-control cash-notes" data-type="other_liquid" placeholder="e.g., T-Bills, CDs"></td>
                                    </tr>
                                    <tr>
                                        <th>Total Cash</th>
                                        <td class="text-end fw-bold cash-total">$0</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Provider management
            let providers = [];
            let nextProviderId = 1;
            let currentYear = new Date().getFullYear();
            let currentQuarter = Math.floor((new Date().getMonth() + 3) / 3);
            
            // Load providers from local storage on page load
            document.addEventListener('DOMContentLoaded', function() {
                // Check if we have saved period in localStorage
                const savedYear = localStorage.getItem('investGenie_selectedYear');
                const savedQuarter = localStorage.getItem('investGenie_selectedQuarter');
                
                if (savedYear && savedQuarter) {
                    currentYear = parseInt(savedYear);
                    currentQuarter = parseInt(savedQuarter);
                }
                
                // Initialize the year select with the last 5 years
                const yearSelect = document.getElementById('year-select');
                for (let i = 0; i < 5; i++) {
                    const year = currentYear - i;
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                }
                
                // Set the selected year and quarter
                document.getElementById('year-select').value = currentYear;
                document.getElementById('quarter-select').value = currentQuarter;
                
                // Load periods for dropdown options
                loadAvailablePeriods();
                
                // Load the saved period or default to current
                loadProvidersForPeriod(currentYear, currentQuarter);
                
                // Add event listeners
                document.getElementById('add-provider-btn').addEventListener('click', addProvider);
                document.getElementById('save-providers-btn').addEventListener('click', saveAllProviders);
                
                // Add event listeners to automatically load when year or quarter changes
                document.getElementById('year-select').addEventListener('change', function() {
                    const year = this.value;
                    const quarter = document.getElementById('quarter-select').value;
                    loadProvidersForPeriod(year, quarter);
                });
                
                document.getElementById('quarter-select').addEventListener('change', function() {
                    const year = document.getElementById('year-select').value;
                    const quarter = this.value;
                    loadProvidersForPeriod(year, quarter);
                });
                
                // Add event listener for the Copy Last Allocation button
                document.getElementById('copy-last-period-btn').addEventListener('click', copyLastPeriod);
            });
            
            // Function to load available periods
            function loadAvailablePeriods() {
                fetch('/api/providers/periods')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.periods.length > 0) {
                            // We already initialized the year select with recent years
                            // We could enhance this to mark years with data
                        }
                    })
                    .catch(error => {
                        console.error('Error loading periods:', error);
                    });
            }
            
            // Function to load providers for a specific period
            function loadProvidersForPeriod(year, quarter) {
                // Save selected period to localStorage
                localStorage.setItem('investGenie_selectedYear', year);
                localStorage.setItem('investGenie_selectedQuarter', quarter);
                
                fetch(`/api/providers/list?year=${year}&quarter=${quarter}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Clear existing providers
                            providers = data.providers || [];
                            
                            // Clear the provider list UI
                            document.getElementById('provider-list').innerHTML = '';
                            
                            // Find the highest ID to set nextProviderId
                            nextProviderId = providers.length > 0 ? 
                                providers.reduce((max, provider) => {
                                    const id = parseInt(provider.id.replace('provider-', ''));
                                    return id > max ? id : max;
                                }, 0) + 1 : 1;
                            
                            // Add providers to UI
                            providers.forEach(provider => {
                                addProviderToUI(provider);
                            });
                            
                            // Update the current period indicator
                            const periodIndicator = document.getElementById('current-period-indicator');
                            const periodText = document.getElementById('current-period-text');
                            periodText.textContent = `${year} Q${quarter}`;
                            periodIndicator.style.display = 'block';
                            
                            // Update current year and quarter
                            currentYear = year;
                            currentQuarter = quarter;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading providers for period:', error);
                        alert('Error loading providers. Please try again.');
                    });
            }
            
            // Function to add a new provider
            function addProvider() {
                const providerName = document.getElementById('new-provider-name').value.trim();
                
                if (!providerName) {
                    alert('Please enter a provider name.');
                    return;
                }
                
                // Check if provider already exists
                if (providers.some(p => p.name.toLowerCase() === providerName.toLowerCase())) {
                    alert('A provider with this name already exists.');
                    return;
                }
                
                // Create new provider
                const providerId = 'provider-' + nextProviderId++;
                
                // Initialize all allocation categories with default values of $0
                const provider = {
                    id: providerId,
                    name: providerName,
                    allocation: {
                        equity: {
                            // Default all equity allocations to 0
                            'small_growth': 0,
                            'small_blend': 0,
                            'small_value': 0,
                            'mid_growth': 0,
                            'mid_blend': 0,
                            'mid_value': 0,
                            'large_growth': 0,
                            'large_blend': 0,
                            'large_value': 0
                        },
                        fixed_income: {
                            // Default all fixed income allocations to 0
                            'short_low': 0,
                            'short_mid': 0,
                            'short_high': 0,
                            'mid_low': 0,
                            'mid_mid': 0,
                            'mid_high': 0,
                            'long_low': 0,
                            'long_mid': 0,
                            'long_high': 0
                        },
                        cash: {
                            // Default all cash allocations to 0
                            'cash': { amount: 0, notes: '' },
                            'money_market': { amount: 0, notes: '' },
                            'other_liquid': { amount: 0, notes: '' }
                        }
                    }
                };
                
                providers.push(provider);
                
                // Add provider to UI
                addProviderToUI(provider);
                
                // Clear input
                document.getElementById('new-provider-name').value = '';
                
                // Get the currently selected year and quarter from the UI
                const selectedYear = document.getElementById('year-select').value;
                const selectedQuarter = document.getElementById('quarter-select').value;
                
                // Save providers for the specific selected period
                saveProviders(selectedYear, selectedQuarter);
            }

            // Function to add provider to UI
            function addProviderToUI(provider) {
                // Clone template
                const template = document.getElementById('provider-template');
                const providerCard = template.content.cloneNode(true).querySelector('.provider-card');
                
                // Set provider ID and name
                providerCard.dataset.providerId = provider.id;
                providerCard.querySelector('.provider-name').textContent = provider.name;
                
                // Add event listeners for inputs
                providerCard.querySelectorAll('.equity-cell, .fixed-income-cell, .cash-cell').forEach(input => {
                    input.addEventListener('input', function() {
                        updateProviderTotals(providerCard);
                        updateProviderAllocation(provider.id);
                    });
                    
                    // Set initial values if they exist
                    const type = input.classList.contains('equity-cell') ? 'equity' : 
                                input.classList.contains('fixed-income-cell') ? 'fixed_income' : 'cash';
                    
                    if (type === 'equity' || type === 'fixed_income') {
                        const row = input.dataset.row;
                        const col = input.dataset.col;
                        const key = `${row}_${col}`;
                        
                        if (type === 'equity') {
                            input.value = provider.allocation.equity[key] || 0;
                        } else if (type === 'fixed_income') {
                            input.value = provider.allocation.fixed_income[key] || 0;
                        }
                    } else if (type === 'cash') {
                        const cashType = input.dataset.type;
                        if (provider.allocation.cash[cashType]) {
                            input.value = provider.allocation.cash[cashType].amount || 0;
                        } else {
                            input.value = 0;
                        }
                    }
                });
                
                // Set initial values for cash notes
                providerCard.querySelectorAll('.cash-notes').forEach(input => {
                    const cashType = input.dataset.type;
                    if (provider.allocation.cash[cashType] && provider.allocation.cash[cashType].notes) {
                        input.value = provider.allocation.cash[cashType].notes;
                    } else {
                        input.value = '';
                    }
                    
                    input.addEventListener('input', function() {
                        updateProviderAllocation(provider.id);
                    });
                });
                
                // Add remove event listener
                providerCard.querySelector('.remove-provider-btn').addEventListener('click', function() {
                    if (confirm(`Are you sure you want to remove ${provider.name}?`)) {
                        removeProvider(provider.id);
                    }
                });
                
                // Add to provider list
                document.getElementById('provider-list').appendChild(providerCard);
                
                // Calculate totals
                updateProviderTotals(providerCard);
            }

            // Function to update provider totals
            function updateProviderTotals(providerCard) {
                // Calculate equity totals
                let equityTotal = 0;
                
                // Calculate row totals for equity
                ['small', 'mid', 'large'].forEach(row => {
                    let rowTotal = 0;
                    providerCard.querySelectorAll(`.equity-cell[data-row="${row}"]`).forEach(cell => {
                        rowTotal += Number(cell.value) || 0;
                    });
                    providerCard.querySelector(`.equity-${row}-total`).textContent = formatCurrency(rowTotal);
                    equityTotal += rowTotal;
                });
                
                // Calculate column totals for equity
                ['growth', 'blend', 'value'].forEach(col => {
                    let colTotal = 0;
                    providerCard.querySelectorAll(`.equity-cell[data-col="${col}"]`).forEach(cell => {
                        colTotal += Number(cell.value) || 0;
                    });
                    providerCard.querySelector(`.equity-${col}-total`).textContent = formatCurrency(colTotal);
                });
                
                // Set equity grand total
                providerCard.querySelector('.equity-grand-total').textContent = formatCurrency(equityTotal);
                providerCard.querySelector('.total-equity').textContent = formatCurrency(equityTotal);
                
                // Calculate fixed income totals
                let fixedIncomeTotal = 0;
                
                // Calculate row totals for fixed income
                ['short', 'mid', 'long'].forEach(row => {
                    let rowTotal = 0;
                    providerCard.querySelectorAll(`.fixed-income-cell[data-row="${row}"]`).forEach(cell => {
                        rowTotal += Number(cell.value) || 0;
                    });
                    providerCard.querySelector(`.fixed-${row}-total`).textContent = formatCurrency(rowTotal);
                    fixedIncomeTotal += rowTotal;
                });
                
                // Calculate column totals for fixed income
                ['low', 'mid', 'high'].forEach(col => {
                    let colTotal = 0;
                    providerCard.querySelectorAll(`.fixed-income-cell[data-col="${col}"]`).forEach(cell => {
                        colTotal += Number(cell.value) || 0;
                    });
                    providerCard.querySelector(`.fixed-${col}-total`).textContent = formatCurrency(colTotal);
                });
                
                // Set fixed income grand total
                providerCard.querySelector('.fixed-grand-total').textContent = formatCurrency(fixedIncomeTotal);
                providerCard.querySelector('.total-fixed-income').textContent = formatCurrency(fixedIncomeTotal);
                
                // Calculate cash total
                let cashTotal = 0;
                providerCard.querySelectorAll('.cash-cell').forEach(cell => {
                    cashTotal += Number(cell.value) || 0;
                });
                
                providerCard.querySelector('.cash-total').textContent = formatCurrency(cashTotal);
                
                // Set overall grand total
                const grandTotal = equityTotal + fixedIncomeTotal + cashTotal;
                providerCard.querySelector('.provider-grand-total').textContent = formatCurrency(grandTotal);
            }

            // Function to update provider allocation
            function updateProviderAllocation(providerId) {
                const provider = providers.find(p => p.id === providerId);
                if (!provider) return;
                
                const providerCard = document.querySelector(`.provider-card[data-provider-id="${providerId}"]`);
                
                // Update equity allocation - always set all values
                provider.allocation.equity = {
                    'small_growth': 0,
                    'small_blend': 0,
                    'small_value': 0,
                    'mid_growth': 0,
                    'mid_blend': 0,
                    'mid_value': 0,
                    'large_growth': 0,
                    'large_blend': 0,
                    'large_value': 0
                };
                
                providerCard.querySelectorAll('.equity-cell').forEach(cell => {
                    const row = cell.dataset.row;
                    const col = cell.dataset.col;
                    const value = Number(cell.value) || 0;
                    const key = `${row}_${col}`;
                    provider.allocation.equity[key] = value;
                });
                
                // Update fixed income allocation - always set all values
                provider.allocation.fixed_income = {
                    'short_low': 0,
                    'short_mid': 0,
                    'short_high': 0,
                    'mid_low': 0,
                    'mid_mid': 0,
                    'mid_high': 0,
                    'long_low': 0,
                    'long_mid': 0,
                    'long_high': 0
                };
                
                providerCard.querySelectorAll('.fixed-income-cell').forEach(cell => {
                    const row = cell.dataset.row;
                    const col = cell.dataset.col;
                    const value = Number(cell.value) || 0;
                    const key = `${row}_${col}`;
                    provider.allocation.fixed_income[key] = value;
                });
                
                // Update cash allocation - always set all values
                provider.allocation.cash = {
                    'cash': { amount: 0, notes: '' },
                    'money_market': { amount: 0, notes: '' },
                    'other_liquid': { amount: 0, notes: '' }
                };
                
                providerCard.querySelectorAll('.cash-cell').forEach(cell => {
                    const cashType = cell.dataset.type;
                    const value = Number(cell.value) || 0;
                    const notesField = providerCard.querySelector(`.cash-notes[data-type="${cashType}"]`);
                    const notes = notesField ? notesField.value : '';
                    
                    provider.allocation.cash[cashType] = {
                        amount: value,
                        notes: notes
                    };
                });
                
                // Get the currently selected year and quarter from the UI
                const selectedYear = document.getElementById('year-select').value;
                const selectedQuarter = document.getElementById('quarter-select').value;
                
                // Save providers for the specific selected period
                saveProviders(selectedYear, selectedQuarter);
            }

            // Function to remove provider
            function removeProvider(providerId) {
                // Remove from array
                providers = providers.filter(p => p.id !== providerId);
                
                // Remove from UI
                const providerCard = document.querySelector(`.provider-card[data-provider-id="${providerId}"]`);
                if (providerCard) {
                    providerCard.remove();
                }
                
                // Get the currently selected year and quarter from the UI
                const selectedYear = document.getElementById('year-select').value;
                const selectedQuarter = document.getElementById('quarter-select').value;
                
                // Save providers for the specific selected period
                saveProviders(selectedYear, selectedQuarter);
            }

            // Function to save all providers
            function saveAllProviders() {
                // Get the current year and quarter from the selectors
                const year = document.getElementById('year-select').value;
                const quarter = document.getElementById('quarter-select').value;
                
                // Save to localStorage
                localStorage.setItem('investGenie_selectedYear', year);
                localStorage.setItem('investGenie_selectedQuarter', quarter);
                
                saveProviders(year, quarter);
                
                // Update the current period indicator
                const periodIndicator = document.getElementById('current-period-indicator');
                const periodText = document.getElementById('current-period-text');
                periodText.textContent = `${year} Q${quarter}`;
                periodIndicator.style.display = 'block';
                
                alert(`All provider allocations saved successfully for ${year} Q${quarter}!`);
            }

            // Function to save providers to server
            function saveProviders(year, quarter) {
                // This function will only update the allocation file for the specified year and quarter
                fetch('/api/providers/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        providers: providers,
                        year: year,
                        quarter: quarter
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log(`Providers saved for ${year} Q${quarter}`);
                    } else {
                        console.error(`Error saving providers: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error saving providers:', error);
                });
                
                // Also update the global tracking variables to match current selection
                currentYear = year;
                currentQuarter = quarter;
            }

            // Helper function to format currency
            function formatCurrency(value) {
                return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }

            // Function to copy allocations from the previous period
            function copyLastPeriod() {
                const currentYear = parseInt(document.getElementById('year-select').value);
                const currentQuarter = parseInt(document.getElementById('quarter-select').value);
                
                // Calculate previous period
                let prevYear = currentYear;
                let prevQuarter = currentQuarter - 1;
                
                // If it's Q1, go to Q4 of the previous year
                if (prevQuarter < 1) {
                    prevYear = currentYear - 1;
                    prevQuarter = 4;
                }
                
                // Try to load from previous period directly
                fetch(`/api/providers/list?year=${prevYear}&quarter=${prevQuarter}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.providers && data.providers.length > 0) {
                            // Store current year and quarter to restore later
                            const targetYear = currentYear;
                            const targetQuarter = currentQuarter;
                            
                            // We have the previous period's providers, now save them to the current period
                            providers = data.providers;
                            
                            // Clear the provider list UI and rebuild it
                            document.getElementById('provider-list').innerHTML = '';
                            providers.forEach(provider => {
                                addProviderToUI(provider);
                            });
                            
                            // Save these providers to the current period
                            saveProviders(targetYear, targetQuarter);
                            
                            // Update UI
                            const periodIndicator = document.getElementById('current-period-indicator');
                            const periodText = document.getElementById('current-period-text');
                            periodText.textContent = `${targetYear} Q${targetQuarter}`;
                            periodIndicator.style.display = 'block';
                            
                            // Show success message
                            alert(`Allocations copied from ${prevYear} Q${prevQuarter} to ${targetYear} Q${targetQuarter}`);
                        } else {
                            throw new Error(`No data exists for ${prevYear} Q${prevQuarter}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error copying from previous period:', error);
                        alert('No allocation data found for the previous period. Please create new allocations for this period.');
                    });
            }
        </script>
    </div>
</body>
</html> 